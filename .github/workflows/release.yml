name: å‘å¸ƒå‘è¡Œç‰ˆ

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: ğŸ“¦ ä¸‹è½½ä¾èµ–
        run: go mod download

      - name: ğŸš€ è¿è¡Œ release-please è·å–ç‰ˆæœ¬å·
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: ğŸ”¨ æ„å»ºæ‰€æœ‰å¹³å°äºŒè¿›åˆ¶
        if: ${{ steps.release.outputs.release_created }}
        env:
          VERSION: ${{ steps.release.outputs.tag_name }}
          COMMIT: ${{ github.sha }}
        run: |
          declare -a GOOS_ARRAY=("linux" "windows" "darwin" "freebsd" "dragonfly" "solaris" "aix" "plan9")
          declare -a GOARCH_ARRAY=("amd64" "arm64" "386" "ppc64" "riscv64")

          mkdir -p dist

          BUILT_AT=$(date -u +%Y-%m-%d_%H:%M:%S)

          for GOOS in "${GOOS_ARRAY[@]}"; do
            for GOARCH in "${GOARCH_ARRAY[@]}"; do
              case "${GOOS}/${GOARCH}" in
                "windows/amd64"|"windows/arm64"|"windows/386"|"linux/amd64"|"linux/arm64"|"linux/386"|"darwin/amd64"|"darwin/arm64"|"freebsd/amd64"|"freebsd/arm64"|"linux/riscv64"|"linux/ppc64"|"dragonfly/amd64"|"solaris/amd64"|"aix/ppc64"|"plan9/amd64"|"plan9/386")
                  ;;
                *)
                  echo "è·³è¿‡ä¸æ”¯æŒçš„ç»„åˆ: ${GOOS}/${GOARCH}"
                  continue
                  ;;
              esac

              BINARY_NAME="JJFreeBooks-${GOOS}-${GOARCH}"
              if [ "$GOOS" = "windows" ]; then
                BINARY_NAME="${BINARY_NAME}.exe"
              fi

              echo "ğŸ“¦ æ­£åœ¨æ„å»º: ${GOOS}/${GOARCH} -> ${BINARY_NAME}"

              CGO_ENABLED=0 GOOS=${GOOS} GOARCH=${GOARCH} go build \
                -ldflags="
                  -s -w \
                  -X main.version=${VERSION} \
                  -X main.commit=${COMMIT} \
                  -X main.date=${BUILT_AT}" \
                -o "dist/${BINARY_NAME}" \
                .

              if [ $? -ne 0 ]; then
                echo "âŒ æ„å»ºå¤±è´¥: ${GOOS}/${GOARCH}"
                exit 1
              fi
            done
          done

          echo "âœ… æ„å»ºå®Œæˆï¼Œäº§ç‰©åˆ—è¡¨ï¼š"
          ls -la dist/

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Actions ä¸´æ—¶å­˜å‚¨
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/*
          retention-days: 7

      - name: ğŸ—ƒ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Release
        if: ${{ steps.release.outputs.release_created }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release.outputs.tag_name }}
          name: ${{ steps.release.outputs.tag_name }}
          body: ${{ steps.release.outputs.release_notes }}
          files: dist/*